<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infographic Editor</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background:#1b1b1b;
      color:#fff;
      font-family: system-ui, sans-serif;
      padding: 28px 16px;
      gap: 18px;
    }

    .card{
      position: relative;
      width: 721px;
      height: 721px;
      background: #0F0F0F;
      overflow: hidden;
    }

    .title{
      position:absolute;
      top: 48px;
      left: 48px;

      color: #FFF;
      font-family: "Funnel Display", system-ui, sans-serif;
      font-size: 80px;
      font-weight: 400;
      line-height: 81.5px;
      margin: 0;
      white-space: pre-line;

      z-index: 2; /* sous la jauge */
    }

    .value{
      position:absolute;
      left: 48px;
      bottom: 48px;

      display:flex;
      width: 552px;
      height: 171px;
      flex-direction: column;
      justify-content: center;

      color:#FFF;
      font-family: "Roboto Mono", monospace;
      font-size: 240px;
      font-weight: 400;
      line-height: 121.5px;
      letter-spacing: -6px;
      margin: 0;

      z-index: 1; /* sous la jauge */
    }

    .gauge{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);

      width: 522px;
      height: 522px;

      pointer-events:none;
      z-index: 3;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.55));
    }

    #sector{
      transition: d 220ms ease, opacity 160ms ease;
    }
    #fullCircle{
      transition: opacity 160ms ease;
    }

    /* Controls */
    .ui{
      width: min(721px, 100%);
      display:flex;
      justify-content:flex-end;
    }
    .panel{
      display:flex;
      flex-direction:column;
      gap: 10px;
      background: rgba(10,12,16,.55);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 14px;
      backdrop-filter: blur(8px);
      width: min(721px, 100%);
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .label{
      font-size: 12px;
      color: rgba(255,255,255,.65);
      letter-spacing:.3px;
      width: 52px;
      text-align:right;
    }
    input[type="range"]{ width: 240px; }
    input[type="number"], input[type="text"]{
      background:#111;
      border:1px solid rgba(255,255,255,.2);
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      outline:none;
      font-size:14px;
    }
    input[type="number"]{ width: 86px; text-align:right; }
    input[type="text"]{ width: 360px; }

    button{
      background:#111;
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:14px;
    }
    button[disabled]{ opacity:.55; cursor:not-allowed; }

    .hint{
      font-size: 12px;
      color: rgba(255,255,255,.5);
      text-align:right;
      margin-top: 2px;
    }
    .status{
      font-size: 12px;
      color: rgba(255,255,255,.55);
      text-align:right;
      min-height: 16px;
    }
  </style>
</head>

<body>

  <div class="card" id="exportArea">
    <h1 class="title" id="titleText">Security<br>rating</h1>
    <p class="value"><span id="pctText">80%</span></p>

    <svg class="gauge" viewBox="0 0 300 300" aria-label="Gauge">
      <defs>
        <radialGradient id="fillRadial" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="rgba(56, 113, 225, 0)" />
          <stop offset="100%" stop-color="#3871E1" />
        </radialGradient>

        <filter id="soften" x="-20%" y="-20%" width="140%" height="140%">
          <feGaussianBlur stdDeviation="0.15" />
        </filter>
      </defs>

      <!-- cercle plein (uniquement à 100) -->
      <circle id="fullCircle" cx="150" cy="150" r="140"
              fill="url(#fillRadial)" filter="url(#soften)" opacity="0"></circle>

      <!-- secteur (0..99) -->
      <path id="sector" d="" fill="url(#fillRadial)" filter="url(#soften)"></path>
    </svg>
  </div>

  <div class="ui">
    <div class="panel">
      <div class="row">
        <div class="label">%</div>
        <input id="range" type="range" min="0" max="100" value="80">
        <input id="num" type="number" min="0" max="100" value="80">
      </div>

      <div class="row">
        <div class="label">Titre</div>
        <input id="titleInput" type="text" value="Security\nrating">
      </div>

      <div class="row">
        <div class="label">Export</div>
        <button id="btnPng">PNG</button>
        <button id="btnJpg">JPG</button>
      </div>

      <div class="hint">Astuce : retour à la ligne avec \n</div>
      <div class="status" id="status"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const exportArea = document.getElementById('exportArea');
    const sector = document.getElementById('sector');
    const fullCircle = document.getElementById('fullCircle');
    const pctText = document.getElementById('pctText');
    const range = document.getElementById('range');
    const num = document.getElementById('num');
    const titleText = document.getElementById('titleText');
    const titleInput = document.getElementById('titleInput');
    const btnPng = document.getElementById('btnPng');
    const btnJpg = document.getElementById('btnJpg');
    const statusEl = document.getElementById('status');

    const cx = 150, cy = 150;
    const radius = 140;

    // Départ “en haut” pour un rendu plus naturel (12h)
    // 0% = rien, 25% = quart, 50% = demi, 75% = 3/4, 99% quasi cercle
    const startAngle = -90;      // 12h
    const fullSweep = 360;       // logique: 0..360

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    function polarToCartesian(cx, cy, r, angleDeg) {
      const a = (angleDeg - 90) * Math.PI / 180;
      return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
    }

    function describeSector(cx, cy, r, startDeg, endDeg) {
      const start = polarToCartesian(cx, cy, r, startDeg);
      const end = polarToCartesian(cx, cy, r, endDeg);
      const delta = endDeg - startDeg;
      const largeArc = delta <= 180 ? 0 : 1;

      return [
        `M ${cx} ${cy}`,
        `L ${start.x} ${start.y}`,
        `A ${r} ${r} 0 ${largeArc} 1 ${end.x} ${end.y}`,
        `Z`
      ].join(' ');
    }

    function setGauge(value){
      const v = clamp(Number(value) || 0, 0, 100);
      pctText.textContent = v + "%";

      // 0% -> rien
      if (v <= 0){
        fullCircle.setAttribute('opacity', '0');
        sector.setAttribute('opacity', '0');
        return;
      }

      // 100% -> cercle plein
      if (v >= 100){
        fullCircle.setAttribute('opacity', '1');
        sector.setAttribute('opacity', '0');
        return;
      }

      // Entre 1 et 99 -> secteur proportionnel
      fullCircle.setAttribute('opacity', '0');
      sector.setAttribute('opacity', '1');

      const end = startAngle + (fullSweep * (v / 100));
      sector.setAttribute('d', describeSector(cx, cy, radius, startAngle, end));
    }

    function syncValue(val){
      const v = clamp(Number(val) || 0, 0, 100);
      range.value = v;
      num.value = v;
      setGauge(v);
    }

    function syncTitle(){
      const raw = (titleInput.value || "");
      titleText.innerHTML = raw.replaceAll("\\n", "<br>");
    }

    function setBusy(busy, msg=""){
      btnPng.disabled = busy;
      btnJpg.disabled = busy;
      statusEl.textContent = msg;
    }

    async function exportImage(type){
      try{
        setBusy(true, "Export en cours…");
        const canvas = await html2canvas(exportArea, {
          scale: 2,
          backgroundColor: null
        });

        const mime = type === "jpeg" ? "image/jpeg" : "image/png";
        const quality = type === "jpeg" ? 0.92 : 1.0;

        const a = document.createElement("a");
        const ext = type === "jpeg" ? "jpg" : "png";
        a.download = `infographic-${num.value}.${ext}`;
        a.href = canvas.toDataURL(mime, quality);
        document.body.appendChild(a);
        a.click();
        a.remove();

        setBusy(false, `Export terminé (${ext.toUpperCase()})`);
      }catch(e){
        console.error(e);
        setBusy(false, "Erreur export (console).");
      }
    }

    range.addEventListener('input', e => syncValue(e.target.value));
    num.addEventListener('input', e => syncValue(e.target.value));
    titleInput.addEventListener('input', syncTitle);

    btnPng.addEventListener('click', () => exportImage("png"));
    btnJpg.addEventListener('click', () => exportImage("jpeg"));

    syncValue(80);
    syncTitle();
  </script>
</body>
</html>




